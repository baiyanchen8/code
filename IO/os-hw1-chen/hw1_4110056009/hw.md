# å¯¦é©—æµç¨‹
## HW1 ï¼ˆä½¿ç”¨fwrite fread....ï¼‰
```c
create_file();             // å»ºç«‹ 100MB æ¸¬è©¦æª”æ¡ˆ
sequential_read();         // æ¸¬è©¦é †åºè®€å–(æ¯æ¬¡è®€å– 4KBï¼‰
sequential_write();        // æ¸¬è©¦é †åºå¯«å…¥(æ¯æ¬¡å¯«å…¥ 2KB ä¸¦ fsyncï¼‰
random_read();             // æ¸¬è©¦éš¨æ©Ÿè®€å–
random_buffered_write_1(); // æ¸¬è©¦éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆä¸ç«‹å³ fsyncï¼‰
random_buffered_write_2(); // æ¸¬è©¦éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆæ¯æ¬¡å¯«å…¥å¾Œç«‹å³ fsyncï¼‰
```

### result
``` text
100MB æª”æ¡ˆå·²å»ºç«‹ã€‚
é †åºè®€å–æ™‚é–“ï¼š0.030928 ç§’
é †åºå¯«å…¥æ™‚é–“ï¼š149.279788 ç§’
éš¨æ©Ÿè®€å–æ™‚é–“ï¼š0.050751 ç§’
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆä¸ç«‹å³åŒæ­¥ï¼‰ï¼š0.452392 ç§’
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆæ¯æ¬¡åŒæ­¥ï¼‰ï¼š203.673432 ç§’
```

## erase cache
```Bash
su root
echo 3 > /proc/sys/vm/drop_caches
exit
```

## HW2(ä½¿ç”¨ Read write....)
```c
create_test_file();               // å»ºç«‹ 100MB æ¸¬è©¦æª”æ¡ˆ
measure_sequential_read();        // æ¸¬é‡é †åºè®€å–
measure_sequential_write();       // æ¸¬é‡é †åºå¯«å…¥
measure_random_read();            // æ¸¬é‡éš¨æ©Ÿè®€å–
measure_random_buffered_write_1();// æ¸¬é‡éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆç„¡åŒæ­¥ï¼‰
measure_random_buffered_write_2();// æ¸¬é‡éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆæ¯æ¬¡å¯«å…¥å¾Œç«‹å³åŒæ­¥ï¼‰
```

### result
``` text
100MB æª”æ¡ˆå·²å»ºç«‹ã€‚
é †åºè®€å–æ™‚é–“ï¼š 0.028579 seconds
é †åºå¯«å…¥æ™‚é–“ï¼š 128.129814 seconds
éš¨æ©Ÿè®€å–æ™‚é–“: 0.096665 seconds
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆç„¡åŒæ­¥ï¼‰æ™‚é–“: 0.942310 seconds
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆæ¯æ¬¡åŒæ­¥ï¼‰æ™‚é–“: 180.121076 seconds
```

## erase cache
```Bash
su root
echo 3 > /proc/sys/vm/drop_caches
exit
```

## HW3(ä½¿ç”¨mmap)
```c
create_test_file();
mmap_sequential_read();
mmap_sequential_write();
mmap_random_read();
mmap_random_buffered_write_1();
mmap_random_buffered_write_2();
```

### result
```text
100MB æª”æ¡ˆå·²å»ºç«‹ã€‚
é †åºè®€å–(mamap)æ™‚é–“ï¼š 0.272896 seconds
é †åºå¯«å…¥(mmap)æ™‚é–“: 56.040899 seconds
éš¨æ©Ÿè®€å–(mmap)æ™‚é–“ï¼š 0.040676 seconds
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆä¸ç«‹å³åŒæ­¥)ï¼š0.332220 seconds
éš¨æ©Ÿç·©è¡å¯«å…¥ï¼ˆæ¯æ¬¡åŒæ­¥ï¼‰ï¼š110.445688 seconds
```

# åˆ†æ
é€™ä»½å¯¦é©—è³‡æ–™ç›¸ç•¶å®Œæ•´ï¼Œæ¶µè“‹äº†ä½¿ç”¨ä¸‰ç¨®ä¸åŒæ–¹å¼ï¼ˆ`fread/fwrite`ã€`read/write`ã€`mmap`ï¼‰ä¾†åš I/O æ¸¬è©¦ï¼Œä¸¦å°æ‡‰äº†é †åºè®€/å¯«ã€éš¨æ©Ÿè®€/å¯«ï¼ˆå«åŒæ­¥èˆ‡ä¸åŒæ­¥ï¼‰ç­‰æ“ä½œã€‚ä¸‹é¢æˆ‘ä¾†å¹«ä½ åšä¸€ä»½æ¸…æ¥šçš„åˆ†æï¼Œä¸¦ç”¨å°ç£å¸¸ç”¨çš„èªªæ³•å‘ˆç¾ï¼š

---

## ğŸ“Š æ•´é«”çµæœå½™æ•´æ¯”è¼ƒè¡¨ï¼š

| æ¸¬è©¦é …ç›® | `fread/fwrite` | `read/write` | `mmap` |
|----------|----------------|--------------|--------|
| é †åºè®€å– | 0.0309s        | 0.0286s      | **0.2729s** â— |
| é †åºå¯«å…¥ | æœ€æ…¢ï¼š149.28s  | 128.13s      | **56.04s** âœ… |
| éš¨æ©Ÿè®€å– | **0.0508s**    | 0.0967s      | 0.0407s âœ… |
| éš¨æ©Ÿå¯«å…¥ï¼ˆä¸åŒæ­¥ï¼‰ | 0.452s     | 0.942s       | **0.332s** âœ… |
| éš¨æ©Ÿå¯«å…¥ï¼ˆæ¯æ¬¡åŒæ­¥ï¼‰ | æœ€æ…¢ï¼š203.67s | 180.12s  | **110.45s** âœ… |

---

## ğŸ” å„å¯¦é©—çµæœåˆ†æ

### âœ… **1. é †åºè®€å–ï¼ˆsequential readï¼‰**
- `fread` / `read` çš„æ•ˆèƒ½éå¸¸æ¥è¿‘ï¼ˆçš† < 0.03sï¼‰ï¼Œé€™æ˜¯å› ç‚º Linux æœ‰æ•ˆä½¿ç”¨äº† **page cache**ï¼Œé †åºå­˜å–æœƒé è®€ï¼ˆreadaheadï¼‰ï¼Œæ•ˆç‡å¾ˆå¥½ã€‚
- `mmap` åè€Œæœ€æ…¢ï¼ˆ0.27sï¼‰ï¼ŒåŸå› å¯èƒ½æ˜¯å› ç‚ºè¦ä½¿ç”¨`mmap`æ˜ å°„åè€Œæœ‰ **Overhead**

### âœ… **2. é †åºå¯«å…¥ï¼ˆsequential writeï¼‰**
- `fwrite` æœ€æ…¢ï¼ˆ149sï¼‰ï¼Œ`write` ä¹Ÿå¾ˆæ…¢ï¼ˆ128sï¼‰ï¼Œä½† `mmap` æœ€å¿«ï¼ˆ56sï¼‰ã€‚
- ç‚ºä»€éº¼ `mmap` å¯«å…¥å¿«ï¼Ÿ
  - å› ç‚º `mmap` å¯«å…¥æ™‚æ˜¯ç›´æ¥ä¿®æ”¹è¨˜æ†¶é«”ï¼Œä¸æœƒé¦¬ä¸Šè§¸ç™¼ `write()` ç³»çµ±å‘¼å«ï¼Œåªè¦æœ€å¾Œä¸€ä½µ `msync()` å¯«å…¥å³å¯ï¼Œç³»çµ±å¯ä»¥å„ªåŒ–å¯«å…¥å‹•ä½œã€‚
  - è€Œ `write/fwrite` æ¯æ¬¡å‘¼å«éƒ½æœƒè§¸ç™¼ç³»çµ±å‘¼å«ï¼Œ`fsync()` åˆæœƒå¼·åˆ¶å¯«å…¥ç£ç¢Ÿï¼Œé–‹éŠ·å¤§ã€‚

### âœ… **3. éš¨æ©Ÿè®€å–ï¼ˆrandom readï¼‰**
- `mmap` èˆ‡ `fread` çš„è¡¨ç¾éƒ½éå¸¸å¥½ï¼ˆ0.04~0.05sï¼‰ï¼Œ`read` ç•¥æ…¢ï¼ˆ0.096sï¼‰ã€‚
- å¯èƒ½æ˜¯å› ç‚º `fread` æœ¬èº«å°±æœ‰å…§å»ºçš„ç·©è¡å€ï¼ˆbufferingï¼‰ï¼Œå¯å¹«å¿™æ¸›å°‘ç³»çµ±å‘¼å«æ¬¡æ•¸ã€‚

### âœ… **4. éš¨æ©Ÿå¯«å…¥ï¼ˆä¸åŒæ­¥ï¼‰**
- `mmap` ä¾ç„¶æœ€å¿«ï¼ˆ0.33sï¼‰ï¼Œ`fwrite` ç´„ 0.45sï¼Œ`write` ç´„ 0.94sã€‚
- ä¸»å› ï¼š
  - `fwrite` æœƒç´¯ç©åˆ°ç·©è¡å€æ‰å¯«å‡ºï¼Œæ•ˆç‡ä¸éŒ¯ã€‚
  - `mmap` ç›´æ¥è¨˜æ†¶é«”ä¿®æ”¹ï¼Œæ•ˆç‡æœ€é«˜ã€‚
  - `write` æ¯æ¬¡éƒ½æœƒé€²å…¥æ ¸å¿ƒï¼Œæ•ˆç‡æœ€å·®ã€‚

### âœ… **5. éš¨æ©Ÿå¯«å…¥ï¼ˆæ¯æ¬¡åŒæ­¥ï¼‰**
- `fwrite` æœ€æ…¢ï¼ˆ203sï¼‰ï¼Œ`write` æ¬¡ä¹‹ï¼ˆ180sï¼‰ï¼Œ`mmap` æœ€å¿«ï¼ˆ110sï¼‰ã€‚
- å·®ç•°é—œéµåœ¨æ–¼ **fsync/msync** é »ç‡èˆ‡æ•ˆèƒ½ï¼š
  - `fsync` æ¯æ¬¡å¼·åˆ¶å¯«å…¥ç£ç¢Ÿï¼Œæˆæœ¬éå¸¸é«˜ã€‚
  - `mmap` çš„ `msync` å¯«å…¥é€šå¸¸èƒ½æ•´æ‰¹åŒæ­¥ï¼Œæ¯”è¼ƒæœ‰æ•ˆç‡ã€‚
